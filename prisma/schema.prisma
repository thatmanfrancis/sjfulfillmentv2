generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String
  role               UserRole
  isVerified         Boolean             @default(false)
  mfaEnabled         Boolean             @default(false)
  mfaSecret          String?
  businessId         String?
  createdAt          DateTime            @default(now())
  firstName          String
  lastLoginAt        DateTime?
  lastName           String
  loginCount         Int                 @default(0)
  updatedAt          DateTime            @updatedAt
  auditLogs          AuditLog[]
  ownedBusiness      Business?           @relation("BusinessOwner")
  LogisticsRegion    LogisticsRegion[]
  notifications      Notification[]
  assignedOrders     Order[]             @relation("AssignedLogistics")
  uploadedImages     ProductImage[]      @relation("ProductImageUploads")
  business           Business?           @relation("BusinessUsers", fields: [businessId], references: [id])
  verificationTokens VerificationToken[]
  requestedTransfers StockTransfer[]     @relation("RequestedTransfers")
  approvedTransfers  StockTransfer[]     @relation("ApprovedTransfers")

  @@index([businessId])
}

model Business {
  id               String           @id @default(uuid())
  name             String           @unique
  logoUrl          String?
  baseCurrency     String           @default("USD")
  isActive         Boolean          @default(false)
  onboardingStatus String           @default("PENDING_VERIFICATION")
  ownerId          String?          @unique
  address          String?
  city             String?
  contactPhone     String?
  country          String?          @default("Nigeria")
  createdAt        DateTime         @default(now())
  state            String?
  updatedAt        DateTime         @updatedAt
  owner            User?            @relation("BusinessOwner", fields: [ownerId], references: [id])
  invoices         Invoice[]
  apiKeys          MerchantApiKey[]
  Order            Order[]
  pricing          PricingTier[]
  products         Product[]
  staff            User[]           @relation("BusinessUsers")

  @@index([ownerId])
  @@index([name])
}

model MerchantApiKey {
  id         String   @id @default(uuid())
  merchantId String
  apiKey     String   @unique
  name       String
  isRevoked  Boolean  @default(false)
  business   Business @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
}

model Warehouse {
  id               String            @id @default(uuid())
  name             String
  region           String
  LogisticsRegion  LogisticsRegion[]
  fulfilledOrders  Order[]           @relation("FulfillmentWarehouse")
  stockAllocations StockAllocation[]
  transfersFrom    StockTransfer[]   @relation("TransfersFrom")
  transfersTo      StockTransfer[]   @relation("TransfersTo")
}

model LogisticsRegion {
  id          String    @id @default(uuid())
  userId      String
  warehouseId String
  User        User      @relation(fields: [userId], references: [id])
  Warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([userId, warehouseId])
  @@index([userId])
}

model Product {
  id               String            @id @default(uuid())
  businessId       String
  sku              String
  name             String
  weightKg         Float
  dimensions       Json
  imageUrl         String?
  orderItems       OrderItem[]
  business         Business          @relation(fields: [businessId], references: [id])
  images           ProductImage[]
  stockAllocations StockAllocation[]
  stockTransfers   StockTransfer[]   @relation("ProductStockTransfers")

  @@unique([businessId, sku])
}

model ProductImage {
  id                 String   @id @default(uuid())
  productId          String
  cloudinaryPublicId String   @unique
  imageUrl           String
  thumbnailUrl       String?
  smallUrl           String?
  mediumUrl          String?
  largeUrl           String?
  altText            String?
  isPrimary          Boolean  @default(false)
  fileSize           Int?
  width              Int?
  height             Int?
  format             String?
  uploadedById       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  uploadedBy         User     @relation("ProductImageUploads", fields: [uploadedById], references: [id])

  @@index([productId])
  @@index([isPrimary])
}

model StockAllocation {
  id                String    @id @default(uuid())
  productId         String
  warehouseId       String
  allocatedQuantity Int       @default(0)
  safetyStock       Int       @default(0)
  product           Product   @relation(fields: [productId], references: [id])
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([warehouseId])
}

model StockTransfer {
  id              String   @id @default(uuid())
  productId       String
  fromWarehouseId String
  toWarehouseId   String
  quantity        Int
  status          String   @default("PENDING") // PENDING, IN_TRANSIT, COMPLETED, CANCELED
  requestedBy     String
  approvedBy      String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  
  product         Product   @relation("ProductStockTransfers", fields: [productId], references: [id])
  fromWarehouse   Warehouse @relation("TransfersFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse     Warehouse @relation("TransfersTo", fields: [toWarehouseId], references: [id])
  requestedByUser User     @relation("RequestedTransfers", fields: [requestedBy], references: [id])
  approvedByUser  User?    @relation("ApprovedTransfers", fields: [approvedBy], references: [id])

  @@index([productId])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([status])
}

model Order {
  id                     String      @id @default(uuid())
  merchantId             String
  externalOrderId        String?
  customerName           String
  customerAddress        String
  customerPhone          String
  orderDate              DateTime
  status                 OrderStatus @default(NEW)
  totalAmount            Float
  fulfillmentWarehouseId String?
  assignedLogisticsId    String?
  assignedLogistics      User?       @relation("AssignedLogistics", fields: [assignedLogisticsId], references: [id])
  fulfillmentWarehouse   Warehouse?  @relation("FulfillmentWarehouse", fields: [fulfillmentWarehouseId], references: [id])
  Business               Business    @relation(fields: [merchantId], references: [id])
  items                  OrderItem[]
  shipments              Shipment?

  @@index([merchantId])
  @@index([status])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
}

model Shipment {
  id               String   @id @default(uuid())
  orderId          String   @unique
  trackingNumber   String?
  carrierName      String?
  labelUrl         String?
  deliveryAttempts Int      @default(1)
  lastStatusUpdate DateTime @updatedAt
  order            Order    @relation(fields: [orderId], references: [id])
}

model PricingTier {
  id             String    @id @default(uuid())
  merchantId     String?
  serviceType    String
  baseRate       Float
  negotiatedRate Float
  rateUnit       String
  createdAt      DateTime  @default(now())
  currency       String    @default("USD")
  updatedAt      DateTime  @updatedAt
  merchant       Business? @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
}

model Invoice {
  id              String        @id @default(uuid())
  merchantId      String
  billingPeriod   String
  issueDate       DateTime      @default(now())
  dueDate         DateTime
  totalDue        Float
  status          InvoiceStatus @default(DRAFT)
  storageCharges  Float         @default(0)
  fulfillmentFees Float         @default(0)
  receivingFees   Float         @default(0)
  otherFees       Float         @default(0)
  amountPaid      Float         @default(0)
  merchant        Business      @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
  @@index([status])
}

model Notification {
  id        String  @id @default(uuid())
  userId    String
  message   String
  linkUrl   String?
  isRead    Boolean @default(false)
  sendEmail Boolean @default(true)
  user      User    @relation(fields: [userId], references: [id])
}

model AuditLog {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  action      String
  details     Json?
  changedById String
  timestamp   DateTime @default(now())
  changedBy   User     @relation(fields: [changedById], references: [id])

  @@index([entityId])
  @@index([changedById])
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Setting {
  id          String  @id @default(uuid())
  key         String  @unique
  value       String
  description String?
}

enum UserRole {
  ADMIN
  MERCHANT
  MERCHANT_STAFF
  LOGISTICS
}

enum OrderStatus {
  NEW
  AWAITING_ALLOC
  DISPATCHED
  PICKED_UP
  DELIVERING
  DELIVERED
  RETURNED
  CANCELED
  ON_HOLD
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
}
