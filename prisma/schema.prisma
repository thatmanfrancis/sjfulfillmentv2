generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AuditLog {
  id          String   @id
  entityType  String
  entityId    String
  action      String
  details     Json?
  changedById String?
  timestamp   DateTime @default(now())
  User        User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)

  @@index([changedById])
  @@index([entityId])
}

model PriceTierGroup {
  id           String        @id @default(uuid())
  name         String
  description  String?
  currency     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  pricingTiers PricingTier[]
}

model AdminApiKey {
  id        String   @id @default(uuid())
  adminId   String
  apiKey    String   @unique
  name      String
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Admin     User     @relation(fields: [adminId], references: [id])

  @@index([adminId])
}

model Business {
  id                             String           @id
  name                           String           @unique
  logoUrl                        String?
  baseCurrency                   String           @default("USD")
  isActive                       Boolean          @default(false)
  onboardingStatus               String           @default("PENDING_VERIFICATION")
  ownerId                        String?          @unique
  address                        String?
  city                           String?
  contactPhone                   String?
  country                        String?          @default("Nigeria")
  createdAt                      DateTime         @default(now())
  state                          String?
  updatedAt                      DateTime
  deletedAt                      DateTime?
  deletedBy                      String?
  User_Business_ownerIdToUser    User?            @relation("Business_ownerIdToUser", fields: [ownerId], references: [id])
  Invoice                        Invoice[]
  MerchantApiKey                 MerchantApiKey[]
  Order                          Order[]
  PricingTier                    PricingTier[]
  Product                        Product[]
  User_User_businessIdToBusiness User[]           @relation("User_businessIdToBusiness")

  @@index([deletedAt])
  @@index([name])
  @@index([ownerId])
}

model Invoice {
  id                 String        @id
  merchantId         String
  billingPeriod      String
  issueDate          DateTime      @default(now())
  dueDate            DateTime
  totalDue           Float
  status             InvoiceStatus @default(DRAFT)
  storageCharges     Float         @default(0)
  fulfillmentFees    Float         @default(0)
  receivingFees      Float         @default(0)
  otherFees          Float         @default(0)
  amountPaid         Float         @default(0)
  paymentDate        DateTime?
  orderId            String?
  priceTierGroupId   String?
  priceTierBreakdown Json?
  Business           Business      @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
  @@index([status])
}

model LogisticsRegion {
  id          String    @id
  userId      String
  warehouseId String
  User        User      @relation(fields: [userId], references: [id])
  Warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([userId, warehouseId])
  @@index([userId])
}

model MerchantApiKey {
  id         String   @id
  merchantId String
  apiKey     String   @unique
  name       String
  isRevoked  Boolean  @default(false)
  Business   Business @relation(fields: [merchantId], references: [id])

  @@index([merchantId])
}

model Notification {
  id                                  String               @id
  userId                              String?
  message                             String
  linkUrl                             String?
  isRead                              Boolean              @default(false)
  sendEmail                           Boolean              @default(true)
  actionLabel                         String?
  actionUrl                           String?
  audienceType                        String?
  channels                            String[]             @default(["IN_APP"])
  content                             String?
  createdAt                           DateTime             @default(now())
  createdById                         String?
  expiresAt                           DateTime?
  metadata                            Json?
  priority                            NotificationPriority @default(MEDIUM)
  readCount                           Int?                 @default(0)
  scheduledFor                        DateTime?
  sentAt                              DateTime?
  status                              String?              @default("PENDING")
  title                               String
  totalRecipients                     Int?                 @default(0)
  type                                NotificationType     @default(INFO)
  updatedAt                           DateTime
  User_Notification_createdByIdToUser User?                @relation("Notification_createdByIdToUser", fields: [createdById], references: [id])
  User_Notification_userIdToUser      User?                @relation("Notification_userIdToUser", fields: [userId], references: [id])

  @@index([createdById])
  @@index([userId])
}

model Order {
  id                     String               @id
  merchantId             String
  externalOrderId        String?
  trackingNumber         String               @unique
  customerName           String
  customerAddress        String
  customerPhone          String
  orderDate              DateTime
  status                 OrderStatus          @default(NEW)
  totalAmount            Float
  fulfillmentWarehouseId String?
  assignedLogisticsId    String?
  notes                  String?
  User                   User?                @relation(fields: [assignedLogisticsId], references: [id])
  Warehouse              Warehouse?           @relation(fields: [fulfillmentWarehouseId], references: [id])
  Business               Business             @relation(fields: [merchantId], references: [id])
  OrderItem              OrderItem[]
  Shipment               Shipment?
  OrderWarehousePick     OrderWarehousePick[]
  priceTierGroupId       String?
  priceTierBreakdown     Json?

  @@index([merchantId])
  @@index([status])
}

model OrderItem {
  id        String  @id
  orderId   String
  productId String
  quantity  Int
  Order     Order   @relation(fields: [orderId], references: [id])
  Product   Product @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
}

model PricingTier {
  id              String          @id @default(uuid())
  groupId         String?
  merchantId      String?
  productId       String?
  quantity        Int?            @default(1)
  serviceType     String
  baseRate        Float
  negotiatedRate  Float
  discountPercent Float? // Optional percentage discount (e.g., 20 for 20%)
  rateUnit        String
  createdAt       DateTime        @default(now())
  currency        String          @default("USD")
  updatedAt       DateTime        @updatedAt
  Business        Business?       @relation(fields: [merchantId], references: [id])
  PriceTierGroup  PriceTierGroup? @relation(fields: [groupId], references: [id])
  product         Product?        @relation(fields: [productId], references: [id])

  @@index([merchantId])
  @@index([groupId])
}

model Product {
  id                 String               @id
  businessId         String
  sku                String
  name               String
  initialQuantity    Int                  @default(0)
  weightKg           Float
  dimensions         Json
  imageUrl           String?
  price              Float? // Optional price field
  OrderItem          OrderItem[]
  Business           Business             @relation(fields: [businessId], references: [id])
  ProductImage       ProductImage[]
  StockAllocation    StockAllocation[]
  StockTransfer      StockTransfer[]
  OrderWarehousePick OrderWarehousePick[]
  pricingTiers       PricingTier[]

  @@unique([businessId, sku])
}

model ProductImage {
  id                 String   @id
  productId          String
  cloudinaryPublicId String   @unique
  imageUrl           String
  thumbnailUrl       String?
  smallUrl           String?
  mediumUrl          String?
  largeUrl           String?
  altText            String?
  isPrimary          Boolean  @default(false)
  fileSize           Int?
  width              Int?
  height             Int?
  format             String?
  uploadedById       String
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  Product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User               User     @relation(fields: [uploadedById], references: [id])

  @@index([isPrimary])
  @@index([productId])
}

model Report {
  id              String    @id
  title           String
  name            String?
  description     String?
  type            String?
  category        String?
  status          String?   @default("DRAFT")
  format          String?   @default("PDF")
  frequency       String?   @default("ONCE")
  filePath        String?
  fileSize        String?
  configuration   Json?
  scheduledFor    DateTime?
  // ...existing fields...
  lastGeneratedAt DateTime?
  nextScheduledAt DateTime?
  generationCount Int?      @default(0)
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  createdById     String?
  User            User?     @relation(fields: [createdById], references: [id])

  @@index([createdById])
  @@index([status])
}

model Setting {
  id              String   @id
  key             String   @unique
  value           String
  description     String?
  category        String?  @default("GENERAL")
  createdAt       DateTime @default(now())
  defaultValue    String?
  isEditable      Boolean? @default(true)
  isPublic        Boolean? @default(false)
  isRequired      Boolean? @default(false)
  name            String?
  scope           String?  @default("GLOBAL")
  type            String?  @default("STRING")
  updatedAt       DateTime
  updatedById     String?
  validationRules Json?
  User            User?    @relation(fields: [updatedById], references: [id])

  @@index([category])
  @@index([updatedById])
}

model Shipment {
  id                 String   @id
  orderId            String   @unique
  trackingNumber     String?
  carrierName        String?
  labelUrl           String?
  deliveryAttempts   Int      @default(1)
  lastStatusUpdate   DateTime
  notes              String?
  price              Float? // Shipment price (sum of price tier breakdown + order cost/amount)
  currency           String? // Currency for shipment price
  priceTierBreakdown Json? // Price tier breakdown for shipment
  Order              Order    @relation(fields: [orderId], references: [id])
}

model StockAllocation {
  id                String    @id
  productId         String
  warehouseId       String
  allocatedQuantity Int       @default(0)
  safetyStock       Int       @default(0)
  Product           Product   @relation(fields: [productId], references: [id])
  Warehouse         Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([warehouseId])
}

model StockTransfer {
  id                                                 String    @id
  productId                                          String
  fromWarehouseId                                    String
  toWarehouseId                                      String
  quantity                                           Int
  status                                             String    @default("PENDING")
  requestedBy                                        String
  approvedBy                                         String?
  notes                                              String?
  createdAt                                          DateTime  @default(now())
  updatedAt                                          DateTime
  completedAt                                        DateTime?
  User_StockTransfer_approvedByToUser                User?     @relation("StockTransfer_approvedByToUser", fields: [approvedBy], references: [id])
  Warehouse_StockTransfer_fromWarehouseIdToWarehouse Warehouse @relation("StockTransfer_fromWarehouseIdToWarehouse", fields: [fromWarehouseId], references: [id])
  Product                                            Product   @relation(fields: [productId], references: [id])
  User_StockTransfer_requestedByToUser               User      @relation("StockTransfer_requestedByToUser", fields: [requestedBy], references: [id])
  Warehouse_StockTransfer_toWarehouseIdToWarehouse   Warehouse @relation("StockTransfer_toWarehouseIdToWarehouse", fields: [toWarehouseId], references: [id])

  @@index([fromWarehouseId])
  @@index([productId])
  @@index([status])
  @@index([toWarehouseId])
}

model User {
  id                                            String              @id
  email                                         String              @unique
  passwordHash                                  String
  role                                          UserRole
  isVerified                                    Boolean             @default(false)
  mfaEnabled                                    Boolean             @default(false)
  mfaSecret                                     String?
  businessId                                    String?
  createdAt                                     DateTime            @default(now())
  firstName                                     String
  lastLoginAt                                   DateTime?
  lastName                                      String
  loginCount                                    Int                 @default(0)
  updatedAt                                     DateTime
  bio                                           String?
  department                                    String?
  emailNotifications                            Boolean             @default(true)
  language                                      String?             @default("en")
  location                                      String?
  phone                                         String?
  position                                      String?
  profileImage                                  String?
  smsNotifications                              Boolean             @default(false)
  timezone                                      String?             @default("UTC")
  twoFactorEnabled                              Boolean             @default(false)
  AuditLog                                      AuditLog[]
  Business_Business_ownerIdToUser               Business?           @relation("Business_ownerIdToUser")
  LogisticsRegion                               LogisticsRegion[]
  Notification_Notification_createdByIdToUser   Notification[]      @relation("Notification_createdByIdToUser")
  Notification_Notification_userIdToUser        Notification[]      @relation("Notification_userIdToUser")
  Order                                         Order[]
  ProductImage                                  ProductImage[]
  Report                                        Report[]
  Setting                                       Setting[]
  StockTransfer_StockTransfer_approvedByToUser  StockTransfer[]     @relation("StockTransfer_approvedByToUser")
  StockTransfer_StockTransfer_requestedByToUser StockTransfer[]     @relation("StockTransfer_requestedByToUser")
  Business_User_businessIdToBusiness            Business?           @relation("User_businessIdToBusiness", fields: [businessId], references: [id])
  VerificationToken                             VerificationToken[]
  adminApiKeys                                  AdminApiKey[]

  @@index([businessId])
}

model VerificationToken {
  id        String   @id
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model OrderWarehousePick {
  id          String   @id @default(uuid())
  orderId     String
  productId   String
  warehouseId String
  quantity    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  Order     Order     @relation(fields: [orderId], references: [id])
  Product   Product   @relation(fields: [productId], references: [id])
  Warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([warehouseId])
}

model Warehouse {
  id                                                     String               @id
  name                                                   String
  region                                                 String
  code                                                   String?              @unique
  address                                                String?
  capacity                                               Int?                 @default(0)
  city                                                   String?
  contactEmail                                           String?
  contactPhone                                           String?
  country                                                String?
  createdAt                                              DateTime             @default(now())
  currentStock                                           Int?                 @default(0)
  description                                            String?
  manager                                                String?
  state                                                  String?
  status                                                 String?              @default("ACTIVE")
  type                                                   String?              @default("STORAGE")
  updatedAt                                              DateTime
  zipCode                                                String?
  LogisticsRegion                                        LogisticsRegion[]
  Order                                                  Order[]
  StockAllocation                                        StockAllocation[]
  StockTransfer_StockTransfer_fromWarehouseIdToWarehouse StockTransfer[]      @relation("StockTransfer_fromWarehouseIdToWarehouse")
  StockTransfer_StockTransfer_toWarehouseIdToWarehouse   StockTransfer[]      @relation("StockTransfer_toWarehouseIdToWarehouse")
  OrderWarehousePick                                     OrderWarehousePick[]
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  PROMOTIONAL
  SYSTEM
}

enum OrderStatus {
  NEW
  AWAITING_ALLOC
  ASSIGNED_TO_LOGISTICS
  GOING_TO_PICKUP
  PICKED_UP
  DELIVERING
  DELIVERED
  RETURNED
  CANCELED
  ON_HOLD
}

enum UserRole {
  ADMIN
  MERCHANT
  MERCHANT_STAFF
  LOGISTICS
}
